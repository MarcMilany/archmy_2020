clear
echo ""
echo -e "${BLUE}:: ${NC}Автоматизация обновления зеркал /etc/pacman.d/mirrorlist (запуск Reflector при загрузке), pacman-mirrorlist не обновляется регулярно, вызов рефлектора только потому, что какое-то зеркало в какой-то части земного шара было добавлено или удалено, не имеет значения. Вместо этого используйте автоматизацию на основе таймера. Если вы вообще не хотите mirrorlist.pacnew устанавливаться, используйте NoExtractвpacman.conf."
echo " Reflector поставляется с файлом reflector.service. Служба запустит рефлектор с параметрами, указанными в /etc/xdg/reflector/reflector.conf. Параметры по умолчанию в этом файле должны служить хорошей отправной точкой и примером. "
echo " Чтобы обновить список зеркал досрочно, запустите reflector.service . "
echo " Примечание: reflector.service зависит от службы ожидания сети, которая будет настроена через network-online.target ."
pacman -Sy --noconfirm --needed --noprogressbar --quiet reflector  # Модуль и скрипт Python 3 для получения и фильтрации последнего списка зеркал Pacman ; https://xyne.dev/projects/reflector ; https://archlinux.org/packages/extra/any/reflector/ (reflector --help)
### https://ostechnix.com/retrieve-latest-mirror-list-using-reflector-arch-linux/
pacman -Sy --noconfirm --needed --noprogressbar --quiet pacman-mirrorlist  # отображает версию pacman-mirrors, а затем статус зеркал, которые в данный момент указаны в вашем списке зеркал.
#echo " Начинаем с удаления старой резервной копии (если она есть, если нет, то пропустите этот шаг) " 
#rm /etc/pacman.d/mirrorlist.old
echo " Сохраняем старый список зеркал в качестве резервной копии "
mv /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.old
echo " Обновление списка зеркал (Russia) "
reflector --verbose --country 'Russia' -l 9 -p https -p http -n 9 --save /etc/pacman.d/mirrorlist
# curl -o /etc/pacman.d/mirrorlist https://archlinux.org/mirrorlist/all/  # Загрузите список зеркал напрямую с сайта ; Раскомментируйте предпочитаемые зеркала ; https://wiki.archlinux.org/title/Mirrors
# sed -i 's/^#Server/Server/' /etc/pacman.d/mirrorlist.backup  # чтобы раскомментировать все зеркала
# rankmirrors -n 6 /etc/pacman.d/mirrorlist.backup > /etc/pacman.d/mirrorlist # отсортируйте сервера. В данном случае, -n 6 выводит только 6 наиболее быстрых зеркал
#echo " Переименовываем новый список (mirrorlist) "
#mv /etc/pacman.d/mirrorlist.pacnew /etc/pacman.d/mirrorlist
echo " Пропишем конфигурации в reflector.service "
cat > /usr/lib/systemd/system/reflector.service << EOF
[Unit]
Description=Pacman mirrorlist update
Requires=network.target
After=network.target
[Service]
Type=oneshot
# ExecStart=/usr/bin/reflector --protocol https --latest 30 --number 20 --sort rate --save /etc/pacman.d/mirrorlist
# ExecStart=/usr/bin/reflector -c ru,by,ua,pl -p https,http --sort rate -a 12 -l 10 --save /etc/pacman.d/mirrorlist
ExecStart=/usr/bin/reflector --verbose --country 'Russia' -l 9 -p https -p http -n 9 --save /etc/pacman.d/mirrorlist
[Install]
RequiredBy=network.target

EOF
###
echo -e "${BLUE}:: ${NC}Reflector предоставляет таймер systemd (reflector.timer), который еженедельно запускает службу #systemd reflector.service . Расписание можно изменить, отредактировав reflector.timer ."
echo " Сначала отредактируйте файл конфигурации, как описано в разделе #systemd service ."
echo " После обновления файла конфигурации запустите и включите reflector.timer ."
echo " Пропишем конфигурации в reflector.timer "
cat > /usr/lib/systemd/system/reflector.timer << EOF
[Unit]
Description=Run reflector weekly
[Timer]
OnCalendar=weekly
AccuracySec=12h
Persistent=true
[Install]
WantedBy=timers.target

EOF
###
echo -e "${BLUE}:: ${NC}Reflector поставляется со службой reflector.service. Она запускает reflector с параметрами, указанными в файле /etc/xdg/reflector/reflector.conf. Опции по умолчанию должны быть хорошей отправной точкой."
echo " Пропишем конфигурации в reflector.conf "
cat > /etc/xdg/reflector/reflector.conf << EOF
#
# After installation, you can update the configuration to use mirrors only. from your country. First you need to check the list of available countries
# reflector —list-countries

#
# See "reflector --help" for details.

# Recommended Options

# Set the output path where the mirrorlist will be saved (--save).
--save /etc/pacman.d/mirrorlist

# Select the transfer protocol (--protocol).
--protocol https
--protocol http

# Select the country (--country).
# Consult the list of available countries with "reflector --list-countries" and
# select the countries nearest to you or the ones that you trust. For example:
 --country Russia

# Use only the  most recently synchronized mirrors (--latest).
--latest  9

# Sort the mirrors by synchronization time (--sort).
--sort age

EOF
###
echo ""
echo " Создать каталог (hooks) в /etc/pacman.d/ "
mkdir /etc/pacman.d/hooks   # Создать каталог hooks в /etc/pacman.d/
echo " Создать файл mirrorupgrade.hook в /etc/pacman.d/hooks/ "
touch /etc/pacman.d/hooks/mirrorupgrade.hook   # Создать файл mirrorupgrade.hook в /etc/pacman.d/hooks/
echo " Пропишем конфигурации в reflector.service "
cat > /etc/pacman.d/hooks/mirrorupgrade.hook << EOF
[Trigger]
Operation = Upgrade
Type = Package
Target = pacman-mirrorlist

[Action]
Description = Updating pacman-mirrorlist with reflector
When = PostTransaction
Depends = reflector
#Exec = /usr/bin/reflector -c ru -p https,http --sort rate -a 12 -l 10 --save /etc/pacman.d/mirrorlist
Exec = /usr/bin/reflector --verbose --country 'Russia' -l 9 -p https -p http -n 9 --save /etc/pacman.d/mirrorlist

EOF
###
echo ""
echo -e "${BLUE}:: ${NC}Подключаем reflector.service в автозагрузку"
systemctl enable reflector.service
echo " reflector.service успешно добавлен в автозагрузку "
#echo ""
#echo -e "${BLUE}:: ${NC}Запускаем reflector.service "
#systemctl start reflector.service
#echo " reflector.service успешно запущен "
###
echo ""
echo -e "${BLUE}:: ${NC}Подключаем reflector.timer в автозагрузку"
systemctl enable reflector.timer
#systemctl start reflector.timer
echo " reflector.timer успешно добавлен в автозагрузку "
pacman -Syyuu  # Важно: В большинстве случаев, при принудительном обновлении базы данных pacman, необходимо также принудительно откатить "слишком новые" пакеты, чтобы их версии соответствовали версиям на новом зеркале. Это предотвращает проблемы, приводящие к частичному обновлению системы.
sleep 1
###################